# 技术架构图文档

## 1. 系统架构概览

```
┌─────────────────┐     ┌─────────────────────────────────────────────────────────────────────┐     ┌─────────────────┐
│                 │     │                          后端服务 (Go-Zero)                          │     │                 │
│   微信小程序端   │     │                                                                     │     │   第三方服务    │
│   (前端)        │◄────┤  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │◄────┤  - 微信开放平台 │
│                 │     │  │  用户服务  │  │ 目的地服务 │  │ 行程服务  │  │ 社交服务  │  │ 市场服务  │  │     │  - 地图服务     │
└─────────────────┘     │  │ User API │  │Dest API  │  │Itin API  │  │Social API│  │Market API│  │     │  - 天气服务     │
                        │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │     │  - 酒店/交通API │
                        │         │            │            │            │            │           │     │  - 支付服务     │
                        │         ▼            ▼            ▼            ▼            ▼           │     └─────────────────┘
                        │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
                        │  │  用户RPC  │  │ 目的地RPC │  │ 行程RPC  │  │ 社交RPC  │  │ 市场RPC  │  │
                        │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
                        │         │            │            │            │            │           │
                        │         └────────────┴────────────┴────────────┴────────────┘           │
                        │                                │                                        │
                        │                                ▼                                        │
                        │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
                        │  │    MongoDB     │  │     Redis      │  │     Kafka      │               │
                        │  │  (主数据库)    │  │  (缓存/会话)   │  │  (消息队列)    │               │
                        │  └────────────────┘  └────────────────┘  └────────────────┘               │
                        └─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 微服务详细架构

### 2.1 用户服务 (User Service)

#### 2.1.1 API层 (user-api)
- 负责处理HTTP请求
- 实现用户认证与授权
- 请求参数验证
- 响应格式化

#### 2.1.2 RPC层 (user-rpc)
- 用户信息管理核心逻辑
- 权限控制
- 数据持久化
- 缓存管理

#### 2.1.3 数据存储
- MongoDB: 用户基本信息、偏好设置
- Redis: 会话管理、令牌存储

### 2.2 目的地服务 (Destination Service)

#### 2.2.1 API层 (destination-api)
- 目的地搜索与推荐
- 目的地详情查询
- 实时数据聚合接口

#### 2.2.2 RPC层 (destination-rpc)
- 目的地数据管理
- 第三方API集成逻辑
- 缓存策略实现
- 搜索算法实现

#### 2.2.3 数据存储
- MongoDB: 目的地基础信息
- Redis: 热门目的地缓存、搜索结果缓存

### 2.3 行程服务 (Itinerary Service)

#### 2.3.1 API层 (itinerary-api)
- 行程CRUD接口
- 行程节点管理
- 行程协作接口
- 地图集成接口

#### 2.3.2 RPC层 (itinerary-rpc)
- 行程核心业务逻辑
- 智能行程规划算法
- 数据验证与处理
- 协作权限控制

#### 2.3.3 数据存储
- MongoDB: 行程数据、节点数据、协作关系
- Redis: 活跃行程缓存
- Kafka: 行程变更事件

### 2.4 社交服务 (Social Service)

#### 2.4.1 API层 (social-api)
- 行程分享接口
- 评论与点赞接口
- 消息通知接口

#### 2.4.2 RPC层 (social-rpc)
- 社交关系管理
- 互动数据处理
- 消息推送逻辑

#### 2.4.3 数据存储
- MongoDB: 分享记录、评论、点赞
- Redis: 实时通知
- Kafka: 社交事件流

### 2.5 市场服务 (Marketplace Service)

#### 2.5.1 API层 (marketplace-api)
- 行程商品管理接口
- 订单与支付接口
- 评论与评分接口

#### 2.5.2 RPC层 (marketplace-rpc)
- 商品发布与审核逻辑
- 订单处理流程
- 支付集成逻辑
- 交易安全控制

#### 2.5.3 数据存储
- MongoDB: 行程商品、订单、评论
- Redis: 订单状态缓存
- Kafka: 交易事件流

## 3. 服务间通信

### 3.1 同步通信
- 使用Go-Zero内置的RPC框架
- 基于Protobuf定义服务接口
- 支持服务发现与负载均衡
- 超时控制与重试机制

### 3.2 异步通信
- 使用Kafka作为消息队列
- 事件驱动架构，服务间通过事件解耦
- 支持消息持久化与重播
- 主要事件类型：
  - 用户事件：注册、登录、资料更新
  - 行程事件：创建、更新、删除、分享
  - 订单事件：创建、支付、取消、退款

## 4. 数据流

### 4.1 用户请求流程
1. 微信小程序发起HTTPS请求
2. API网关进行认证与路由
3. 对应微服务API层处理请求
4. 调用RPC层处理核心业务逻辑
5. 数据持久化或第三方API调用
6. 结果沿原路径返回

### 4.2 实时数据获取流程
1. 用户请求需要实时数据的资源
2. 服务API层调用本地缓存
3. 缓存未命中时调用第三方API
4. 返回数据并异步更新缓存
5. 设置合理缓存过期时间

## 5. 安全架构

### 5.1 认证与授权
- 基于JWT的令牌认证
- 细粒度的RBAC权限控制
- OAuth2.0集成微信登录

### 5.2 数据安全
- 敏感数据加密存储
- HTTPS传输加密
- 数据访问审计日志

### 5.3 接口安全
- 请求频率限制
- 参数验证与过滤
- CSRF防护
- SQL注入防护